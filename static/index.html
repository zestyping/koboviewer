<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" type="text/css" href="static/leaflet.css">
<style>
    body { margin: 0; font-family: helvetica; }
    #map { width: 100%; height: 100%; }
    #status, #sync {
      position: absolute;
      left: 0;
      bottom: 0;
      margin: 6px;
      padding: 6px;
      border: 1px solid #999;
      background: #fff;
      font-size: 14px;
      z-index: 1000;
    }
    #locate {
      position: absolute;
      right: 10px;
      bottom: 24px;
      width: 30px;
      height: 30px;
      background: #fff;
      border: 2px solid rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      z-index: 1000;
      -webkit-tap-highlight-color: rgba(51, 181, 229, 0.4);
    }
    #locate:hover { background: #f4f4f4; }
    #locate img { margin: 3px; }
    #times {
      position: absolute;
      right: 0;
      top: 0;
      margin: 6px;
      padding: 6px;
      border: 1px solid #999;
      background: #fff;
      font-size: 14px;
      z-index: 1000;
    }
</style>
<script src="static/jquery-3.2.1.min.js"></script>
<script src="static/leaflet.js"></script>
<script src="static/config.js"></script>
<script src="static/koboviewer.js"></script>

<div id="map"></div>
<div id="status"></div>
<div id="sync"><button>Check for new data</button></div>
<div id="locate"><img src="static/locate-24.png"></div>
<div id="times">
  Show data collected since:
  <select id="min-time">
    <option value="2017-09-11">Sep 11</option>
    <option value="2017-09-10">Sep 10</option>
    <option value="2017-09-09">Sep 09</option>
    <option value="2017-09-08">Sep 08</option>
    <option value="2017-09-07" selected>Sep 07</option>
    <option value="2017-09-06">Sep 06</option>
    <option value="2017-09-05">Sep 05</option>
    <option value="2017-09-04">Sep 04</option>
    <option value="2017-09-03">Sep 03</option>
    <option value="2017-09-02">Sep 02</option>
    <option value="2017-09-01">Sep 01</option>
    <option value="2017-08-31">Aug 31</option>
    <option value="2017-08-30">Aug 30</option>
    <option value="2017-08-29">Aug 29</option>
    <option value="2017-08-28">Aug 28</option>
    <option value="2017-08-27">Aug 27</option>
  </select>
</div>

<script>
  var minTime = '2017-09-07';

  function loadForm(form, callback) {
    var noun = (form.description.match(/drain_point/) ? 'points' :
                form.description.match(/drain_segment/) ? 'segments' :
                'records');
    setStatus('Loading ' + form.description +
              ' (' + form.num_of_submissions + ' ' + noun + ')...');
    syncRecords(form.formid, function() {
      showRecords(map, form.formid, minTime);
      setStatus(null);
      callback();
    });
  }

  $('#min-time').change(function() {
    minTime = $('#min-time').val();
    for (var formId in recordsByFormId) {
      showRecords(map, formId, minTime);
    }
  });

  var map = newOsmMap('map');
  map.setView(new L.LatLng(-6.764, 39.250), 14);  // Mikocheni
  setStatus('Loading forms...');
  syncForms(function() {
    var seg115 = forms[124];
    var seg114 = forms[119];
    var seg113 = forms[113];
    var seg112 = forms[104];
    var seg111 = forms[85];

    var pt115 = forms[123];
    var pt114 = forms[118];
    var pt113 = forms[114];
    var pt112 = forms[103];
    var pt111 = forms[84];

    loadForm(seg115, function() {
      loadForm(pt115, function() {
        loadForm(seg114, function() {
          loadForm(pt114, function() {
            loadForm(seg113, function() {
              loadForm(pt113, function() {
                return;
                loadForm(seg112, function() {
                  loadForm(pt112, function() {
                    loadForm(seg111, function() {
                      loadForm(pt111, function() {
                      });
                    });
                  });
                });
              });
            });
          });
        });
      });
    });

    $('#sync').click(function() {
      var fi = 124, form = forms[fi];
      setStatus('Refreshing ' + form.description + '...');
      syncRecords(fi, function() {
        var fi = 124, form = forms[fi];
        showRecords(map, fi, minTime);

        var fi = 123, form = forms[fi];
        setStatus('Refreshing ' + form.description + '...');
        syncRecords(fi, function() {
          var fi = 123, form = forms[fi];
          showRecords(map, fi, minTime);
          setStatus(null);
        });
      });
    });
  });

  var locationMarker = null;
  var locationHandler = null;
  $('#locate').click(function() {
    map.locate({setView: true, maxZoom: 15});
    if (!locationHandler) {
      map.on('locationfound', function(e) {
        if (!locationMarker) {
          locationMarker = L.circleMarker(
            e.latlng,
            {fillOpacity: 0.2, color: '#0000ff', fillColor: '#0000ff', radius: 8, stroke: true, weight: 1}
          );
          locationMarker.addTo(map);
        }
        locationMarker.setLatLng(e.latlng);
      });
      locationHandler = true;
      setInterval(function() { map.locate({setView: false}); }, 1000);
    }
  });
</script>
